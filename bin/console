#!/bin/bash

# OnLive WhatsApp Order Plugin - Console Tool
# Comprehensive FTP management for the WhatsApp order plugin

set -e

# ============================================================================
# COLOR CODES
# ============================================================================
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
MAGENTA='\033[0;35m'
BOLD='\033[1m'
NC='\033[0m' # No Color

# ============================================================================
# FTP CONFIGURATION
# ============================================================================
FTP_USER="copilot@craftswear.com"
FTP_PASS="so90987098joep"
FTP_HOST="ftp.craftswear.com"
FTP_REMOTE="/wp-content/plugins/onlive-whatsapp-order"

# Get script directory
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
cd "$SCRIPT_DIR"

# ============================================================================
# UTILITY FUNCTIONS
# ============================================================================

# Show colored header
show_header() {
  echo -e "${CYAN}${BOLD}╔════════════════════════════════════════════════════╗${NC}"
  echo -e "${CYAN}${BOLD}║  OnLive WhatsApp Order Plugin - Console Tool       ║${NC}"
  echo -e "${CYAN}${BOLD}╚════════════════════════════════════════════════════╝${NC}"
  echo
}

# Show help menu
show_help() {
  show_header
  
  echo -e "${BOLD}${YELLOW}USAGE:${NC}"
  echo "  ./bin/console [command] [options]"
  echo
  
  echo -e "${BOLD}${YELLOW}COMMANDS:${NC}"
  echo
  
  echo -e "  ${CYAN}update${NC}"
  echo -e "    Upload .php and .js files to live server (overwrite)"
  echo -e "    ${BLUE}Usage:${NC} ./bin/console update"
  echo
  
  echo -e "  ${CYAN}upload${NC}"
  echo -e "    Upload specific file(s) or folder"
  echo -e "    ${BLUE}Usage:${NC}"
  echo -e "      ./bin/console upload <file|folder>"
  echo -e "      ./bin/console upload frontend/class-frontend.php"
  echo -e "      ./bin/console upload admin/"
  echo
  
  echo -e "  ${CYAN}create${NC}"
  echo -e "    Create remote directory structure"
  echo -e "    ${BLUE}Usage:${NC}"
  echo -e "      ./bin/console create <path>"
  echo -e "      ./bin/console create admin/tabs"
  echo
  
  echo -e "  ${CYAN}download${NC}"
  echo -e "    Download file(s) from remote server"
  echo -e "    ${BLUE}Usage:${NC}"
  echo -e "      ./bin/console download <file|folder>"
  echo -e "      ./bin/console download error.log"
  echo -e "      ./bin/console download php_error.log"
  echo
  
  echo -e "  ${CYAN}logs${NC}"
  echo -e "    Download all error logs from live server"
  echo -e "    ${BLUE}Usage:${NC} ./bin/console logs"
  echo
  
  echo -e "  ${CYAN}logs:show${NC}"
  echo -e "    Display downloaded logs"
  echo -e "    ${BLUE}Usage:${NC} ./bin/console logs:show"
  echo
  
  echo -e "  ${CYAN}logs:clear${NC}"
  echo -e "    Clear all downloaded logs"
  echo -e "    ${BLUE}Usage:${NC} ./bin/console logs:clear"
  echo
  
  echo -e "  ${CYAN}ping${NC}"
  echo -e "    Test AJAX connectivity to live server"
  echo -e "    ${BLUE}Usage:${NC} ./bin/console ping"
  echo
  
  echo -e "  ${CYAN}test${NC}"
  echo -e "    Run full diagnostics"
  echo -e "    ${BLUE}Usage:${NC} ./bin/console test"
  echo
  
  echo -e "  ${CYAN}status${NC}"
  echo -e "    Show FTP connection status"
  echo -e "    ${BLUE}Usage:${NC} ./bin/console status"
  echo
  
  echo -e "  ${CYAN}help${NC}"
  echo -e "    Show this help message"
  echo -e "    ${BLUE}Usage:${NC} ./bin/console help"
  echo
}

# Test FTP connection
test_ftp_connection() {
  curl -s --user "$FTP_USER:$FTP_PASS" ftp://$FTP_HOST/ -l > /dev/null 2>&1
  return $?
}

# Show connection status
cmd_status() {
  show_header
  
  echo -e "${BOLD}${YELLOW}FTP Connection Status:${NC}"
  echo
  
  if test_ftp_connection; then
    echo -e "  ${GREEN}✓ Connected${NC}"
    echo -e "    Host: ${CYAN}$FTP_HOST${NC}"
    echo -e "    User: ${CYAN}$FTP_USER${NC}"
    echo -e "    Remote Path: ${CYAN}$FTP_REMOTE${NC}"
  else
    echo -e "  ${RED}✗ Connection Failed${NC}"
    echo -e "    Host: ${CYAN}$FTP_HOST${NC}"
    echo -e "    User: ${CYAN}$FTP_USER${NC}"
    return 1
  fi
  
  echo
}

# Update all .php and .js files
cmd_update() {
  show_header
  echo -e "${BOLD}${YELLOW}Uploading .php and .js files...${NC}"
  echo
  
  if ! test_ftp_connection; then
    echo -e "${RED}Cannot proceed without FTP connection${NC}"
    return 1
  fi
  
  echo
  
  # Upload all .php and .js files from the project
  find "$SCRIPT_DIR" -type f \( -name "*.php" -o -name "*.js" \) ! -path "*/ftp_logs/*" ! -path "*/bin/*" | while read -r file; do
    relative_path="${file#$SCRIPT_DIR/}"
    remote_file="$FTP_REMOTE/$relative_path"
    echo -ne "${YELLOW}→${NC} Uploading $relative_path... "
    if curl -s --user "$FTP_USER:$FTP_PASS" -T "$file" "ftp://$FTP_HOST$remote_file" > /dev/null 2>&1; then
      echo -e "${GREEN}✓${NC}"
    else
      echo -e "${RED}✗${NC}"
    fi
  done
  
  echo
  echo -e "${GREEN}Update complete!${NC}"
  echo
}

# Upload specific file or folder
cmd_upload() {
  local target=$1
  
  if [ -z "$target" ]; then
    echo -e "${RED}Error: Please specify file or folder to upload${NC}"
    echo -e "${BLUE}Usage: ./bin/console upload <file|folder>${NC}"
    return 1
  fi
  
  show_header
  echo -e "${BOLD}${YELLOW}Uploading: $target${NC}"
  echo
  
  if ! test_ftp_connection; then
    echo -e "${RED}Cannot proceed without FTP connection${NC}"
    return 1
  fi
  
  echo
  
  # Check if it's a directory
  if [ -d "$target" ]; then
    echo -e "${YELLOW}Directory mode: $target${NC}"
    find "$target" -type f \( -name "*.php" -o -name "*.js" -o -name "*.css" \) | while read -r file; do
      remote_file="$FTP_REMOTE/${file#./}"
      echo -ne "${YELLOW}→${NC} Uploading $file... "
      if curl -s --user "$FTP_USER:$FTP_PASS" -T "$file" "ftp://$FTP_HOST$remote_file" > /dev/null 2>&1; then
        echo -e "${GREEN}✓${NC}"
      else
        echo -e "${RED}✗${NC}"
      fi
    done
  elif [ -f "$target" ]; then
    remote_file="$FTP_REMOTE/${target#./}"
    echo -ne "${YELLOW}→${NC} Uploading $target... "
    if curl -s --user "$FTP_USER:$FTP_PASS" -T "$target" "ftp://$FTP_HOST$remote_file" > /dev/null 2>&1; then
      echo -e "${GREEN}✓${NC}"
    else
      echo -e "${RED}✗${NC}"
      return 1
    fi
  else
    echo -e "${RED}Error: File or folder not found: $target${NC}"
    return 1
  fi
  
  echo
  echo -e "${GREEN}Upload complete!${NC}"
  echo
}

# Create remote directory
cmd_create() {
  local dir_path=$1
  
  if [ -z "$dir_path" ]; then
    echo -e "${RED}Error: Please specify directory path${NC}"
    echo -e "${BLUE}Usage: ./bin/console create <path>${NC}"
    return 1
  fi
  
  show_header
  echo -e "${BOLD}${YELLOW}Creating remote directory: $dir_path${NC}"
  echo
  
  if ! test_ftp_connection; then
    echo -e "${RED}Cannot proceed without FTP connection${NC}"
    return 1
  fi
  
  echo
  local full_path="$FTP_REMOTE/$dir_path"
  echo -ne "${YELLOW}→${NC} Creating $full_path... "
  
  if curl -s --user "$FTP_USER:$FTP_PASS" -Q "MKD $full_path" ftp://$FTP_HOST/ > /dev/null 2>&1; then
    echo -e "${GREEN}✓${NC}"
  else
    echo -e "${RED}✗${NC}"
    return 1
  fi
  
  echo
}

# Download file or folder
cmd_download() {
  local target=$1
  
  if [ -z "$target" ]; then
    echo -e "${RED}Error: Please specify file or folder to download${NC}"
    echo -e "${BLUE}Usage: ./bin/console download <file|folder>${NC}"
    return 1
  fi
  
  show_header
  echo -e "${BOLD}${YELLOW}Downloading: $target${NC}"
  echo
  
  if ! test_ftp_connection; then
    echo -e "${RED}Cannot proceed without FTP connection${NC}"
    return 1
  fi
  
  mkdir -p ./ftp_logs
  
  local remote_path="$FTP_REMOTE/$target"
  local local_path="./ftp_logs/$target"
  
  echo
  echo -ne "${YELLOW}→${NC} Downloading $target... "
  
  if curl -s --user "$FTP_USER:$FTP_PASS" "ftp://$FTP_HOST$remote_path" -o "$local_path" 2>&1; then
    if [ -s "$local_path" ]; then
      echo -e "${GREEN}✓${NC}"
      echo -e "  Saved to: ${CYAN}$local_path${NC}"
      echo -e "  Size: ${CYAN}$(wc -c < "$local_path") bytes${NC}"
    else
      echo -e "${RED}(empty)${NC}"
      rm -f "$local_path"
    fi
  else
    echo -e "${RED}✗${NC}"
    rm -f "$local_path"
    return 1
  fi
  
  echo
}

# Download all error logs
cmd_logs() {
  show_header
  echo -e "${BOLD}${YELLOW}Downloading error logs from live server...${NC}"
  echo
  
  if ! test_ftp_connection; then
    echo -e "${RED}Cannot proceed without FTP connection${NC}"
    return 1
  fi
  
  mkdir -p ./ftp_logs
  
  local logs=("error.log" "debug.log" "hook-trace.log" "php_error.log" "bootstrap-ajax.log")
  
  echo
  for log_name in "${logs[@]}"; do
    remote_path="$FTP_REMOTE/$log_name"
    local_path="./ftp_logs/$log_name"
    
    echo -ne "${YELLOW}→${NC} Downloading $log_name... "
    
    if curl -s --user "$FTP_USER:$FTP_PASS" "ftp://$FTP_HOST$remote_path" -o "$local_path" 2>&1; then
      if [ -s "$local_path" ]; then
        echo -e "${GREEN}✓${NC} ($(wc -l < "$local_path") lines)"
      else
        echo -e "${RED}(empty)${NC}"
        rm -f "$local_path"
      fi
    else
      echo -e "${RED}✗${NC}"
    fi
  done
  
  echo
  echo -e "${GREEN}Logs saved to ./ftp_logs/${NC}"
  echo
}

# Show logs content
cmd_logs_show() {
  show_header
  echo -e "${BOLD}${YELLOW}Downloaded Error Logs:${NC}"
  echo
  
  if [ ! -d "./ftp_logs" ] || [ -z "$(ls -A ./ftp_logs 2>/dev/null)" ]; then
    echo -e "${RED}No logs found. Run 'console logs' first.${NC}"
    return 1
  fi
  
  for log_file in ./ftp_logs/*.log; do
    if [ -f "$log_file" ]; then
      log_name=$(basename "$log_file")
      lines=$(wc -l < "$log_file")
      echo -e "${MAGENTA}═══════════════════════════════════════════${NC}"
      echo -e "${BOLD}${YELLOW}$log_name ($lines lines)${NC}"
      echo -e "${MAGENTA}═══════════════════════════════════════════${NC}"
      tail -30 "$log_file"
      echo
    fi
  done
}

# Clear logs
cmd_logs_clear() {
  show_header
  
  if [ ! -d "./ftp_logs" ]; then
    echo -e "${YELLOW}No logs directory to clear${NC}"
    return 0
  fi
  
  echo -e "${BOLD}${YELLOW}Clearing downloaded logs...${NC}"
  rm -rf ./ftp_logs
  echo -e "${GREEN}✓ Logs cleared${NC}"
  echo
}

# Test AJAX ping
cmd_ping() {
  show_header
  echo -e "${BOLD}${YELLOW}Testing AJAX connectivity...${NC}"
  echo
  
  response=$(curl -s -X POST \
    -H 'X-Requested-With: XMLHttpRequest' \
    -d 'action=onlive_wa_ping' \
    https://craftswear.com/wp-admin/admin-ajax.php)
  
  echo -e "${BLUE}Server Response:${NC}"
  echo
  echo "$response" | head -20
  echo
  
  if echo "$response" | grep -q '"success"'; then
    echo -e "${GREEN}✓ AJAX endpoint responding with JSON${NC}"
  elif echo "$response" | grep -q '503'; then
    echo -e "${RED}✗ Server returned 503 Service Unavailable${NC}"
  else
    echo -e "${RED}✗ Unexpected response${NC}"
  fi
  echo
}

# Run full diagnostics
cmd_test() {
  show_header
  echo -e "${BOLD}${YELLOW}Running Full Diagnostics...${NC}"
  echo
  
  # 1. Check FTP
  echo -e "${BLUE}${BOLD}1. FTP Connection${NC}"
  cmd_status
  
  # 2. Check local files
  echo -e "${BLUE}${BOLD}2. Local Files${NC}"
  php_count=$(find . -name "*.php" ! -path "./bin/*" ! -path "./ftp_logs/*" 2>/dev/null | wc -l)
  js_count=$(find . -name "*.js" ! -path "./bin/*" ! -path "./ftp_logs/*" 2>/dev/null | wc -l)
  echo -e "  ${CYAN}PHP files: ${GREEN}$php_count${NC}"
  echo -e "  ${CYAN}JS files: ${GREEN}$js_count${NC}"
  echo
  
  # 3. Test AJAX
  echo -e "${BLUE}${BOLD}3. AJAX Connectivity${NC}"
  cmd_ping
  
  echo -e "${YELLOW}Diagnostics complete!${NC}"
  echo
}

# ============================================================================
# MAIN COMMAND HANDLER
# ============================================================================


# Delete a single file from remote server
cmd_delete() {
  local target=$1
  if [ -z "$target" ]; then
    echo -e "${RED}Error: Please specify the file to delete${NC}"
    echo -e "${BLUE}Usage: ./bin/console delete <file>${NC}"
    return 1
  fi

  show_header
  echo -e "${BOLD}${YELLOW}Delete file: $target${NC}"
  echo
  read -p "Are you sure you want to delete '$target' from the remote server? (yes/no): " confirm
  if [[ ! "$confirm" =~ ^[Yy][Ee][Ss]$ ]]; then
    echo -e "${YELLOW}Aborted by user.${NC}"
    return 1
  fi

  if ! test_ftp_connection; then
    echo -e "${RED}Cannot proceed without FTP connection${NC}"
    return 1
  fi

  local remote_path="$FTP_REMOTE/$target"
  echo -ne "${YELLOW}→${NC} Deleting $remote_path... "
  if curl -s --user "$FTP_USER:$FTP_PASS" -Q "DELE $remote_path" ftp://$FTP_HOST/ > /dev/null 2>&1; then
    echo -e "${GREEN}✓ Deleted${NC}"
  else
    echo -e "${RED}✗ Failed to delete${NC}"
    return 1
  fi
  echo
}

main() {
  command=${1:-help}
  shift || true
  case "$command" in
    update)
      cmd_update "$@"
      ;;
    upload)
      cmd_upload "$@"
      ;;
    create)
      cmd_create "$@"
      ;;
    download)
      cmd_download "$@"
      ;;
    delete)
      cmd_delete "$@"
      ;;
    logs)
      cmd_logs "$@"
      ;;
    logs:show)
      cmd_logs_show "$@"
      ;;
    logs:clear)
      cmd_logs_clear "$@"
      ;;
    ping)
      cmd_ping "$@"
      ;;
    test)
      cmd_test "$@"
      ;;
    status)
      cmd_status "$@"
      ;;
    help|--help|-h)
      show_help
      ;;
    *)
      echo -e "${RED}Unknown command: $command${NC}"
      echo
      show_help
      exit 1
      ;;
  esac
}

main "$@"
